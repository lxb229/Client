<!DOCTYPE html>
<html>

<head>
	<meta name="viewport" content="width=device-width">
	<title>角色权限设置</title>
	<meta charset="UTF-8">
	<meta name="renderer" content="webkit">
	<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
	<meta name="apple-mobile-web-app-status-bar-style" content="black">
	<meta name="apple-mobile-web-app-capable" content="yes">
	<meta name="format-detection" content="telephone=no">
	<link href="/lztb/static/plugs/layui/css/layui.css" rel="stylesheet">
</head>

<body>
	<div id="dataForm" class="layui-form" style='padding:20px 30px 20px 0' method="post">
		<div class="layui-form-item" v-for="(onem,index) in oneMenuList">
			<div class="layui-form-label">
				<span>{{onem.text}}</span><br/>
				<input type="checkbox" v-bind:id="'m'+onem.id" lay-filter="menu" name="myMenu" @click="menuClick(onem)" />
			</div>
			<div class="layui-input-block" style="padding:0px 0px 0px 25px;">
				<template v-for="(twom,index) in onem.twoMenuList">
					<div>
						<input type="checkbox" lay-skin="primary" value="1" name="myMenu" lay-filter="menu" :pid="twom.parent" :id="'m'+twom.id"
						 :title="twom.text" @click="menuClick(twom)" />
						<!-- <span>{{twom.text}}</span> -->
						<!-- lay-ignore -->
						<div>
							<span v-for="(threem,index) in twom.threeMenuList"><input type="checkbox" lay-filter="menu" :pid="threem.parent" lay-skin="primary"
							 value="1" :id="'m'+threem.id" name="myMenu" :title="threem.text" @click="menuClick(threem)" /></span>
							<!-- {{threem.text}}&nbsp;&nbsp; -->
						</div>
					</div>
					<hr>
				</template>
			</div>
		</div>
		<div class="hr-line-dashed"></div>
		<div class="layui-form-item text-center">
			<label class="layui-form-label"></label>
			<button @click="saveData()" class="layui-btn">保存数据</button>
		</div>
	</div>
	<script type="text/javascript" src="/lztb/static/plugs/jquery/jquery.min.js"></script>
	<script type="text/javascript" src="/lztb/static/plugs/layui/layui.js"></script>
	<script type="text/javascript" src="/lztb/static/plugs/vue/vue.js"></script>
	<script type="text/javascript" src="/lztb/static/model/site.js"></script>
	<script type="text/javascript">
		var vmMenus = new Vue({
			el: "#dataForm",
			data: {
				haveList: [],
				srcMenuList: [],
				oneMenuList: [],
				editRole: null
			},
			methods: {
				menuClick: function (data) {
					var elem = $('#m' + data.id);
					var isChecked = elem.is(':checked');
					isChecked = isChecked ? true : false;
					selectHandler(elem, isChecked);
				},
				saveData: function () {
					var menus = $("input[name='myMenu']");
					var menuIds = "";
					for (var i = 0; i < menus.length; i++) {
						var isChecked = $(menus[i]).is(":checked");
						if (isChecked) {
							var menuId = $(menus[i]).attr("id");
							menuId = menuId.substring(1);
							menuIds += menuId + ",";
						}
					}
					if (menuIds.length > 0) {
						menuIds = menuIds.substring(0, menuIds.length - 1);
						$.ajax({
							url: '/system/roles/accreditMenu',
							type: 'POST',
							data: { "menusIds": menuIds, "roleId": vmMenus.editRole.roleId },
							dataType: 'json',
							timeout: 10000,
							success: function (rs) {
								if (rs.code == '00000') {
									top.gCloseModalWindow();
									top.SuccessBox("角色权限设置成功!", "提示", 2000);
								} else {
									AlertMsg(rs.msg);
									console.error(rs);
								}
							},
							error: function (xhr, status, ex) {
								top.AlertMsg("请求失败：" + xhr.statusText);
								console.error(ex);
							}
						});
					} else {
						top.AlertMsg("请选择角色的菜单！");
						return;
					}
				}
			},
			created: function () {
				var role = localStorage.getItem("system_role_setmenu_data");
				role = JSON.parse(role);
				this.editRole = role;
				loadMenu();
			}
		});
		//加载菜单数据
		function loadMenu() {
			$.ajax({
				url: '/system/menus/loadMenusTree',
				type: 'POST',
				data: {},
				dataType: 'json',
				timeout: 10000,
				success: function (rs) {
					if (rs.code == '00000') {
						handlerMenuData(rs.data);
					} else {
						AlertMsg(rs.msg);
						console.error(rs);
					}
				},
				error: function (xhr, status, ex) {
					AlertMsg("请求失败：" + xhr.statusText);
					console.error(ex);
				}
			});
		}
		//处理菜单数据 
		function handlerMenuData(srcData) {
			if (!srcData) {
				return;
			}
			vmMenus.srcMenuList = srcData;
			for (var i = 0; i < srcData.length; i++) {
				var one = srcData[i];
				if (one.parent == 0) {
					one.twoMenuList = [];
					vmMenus.oneMenuList.push(one);//添加一级菜单
					for (var j = 0; j < srcData.length; j++) {
						var two = srcData[j];
						if (two.parent == one.id) {
							two.threeMenuList = [];
							one.twoMenuList.push(two);
							for (var k = 0; k < srcData.length; k++) {
								var three = srcData[k];
								if (three.parent == two.id) {
									two.threeMenuList.push(three);
								}
							}
						}
					}
				}
			}
			loadRoleMenu();
		}
		//加载该角色已经分配的菜单
		function loadRoleMenu() {
			$.ajax({
				url: '/system/menus/roleMenus',
				type: 'POST',
				data: vmMenus.editRole,
				dataType: 'json',
				timeout: 10000,
				success: function (rs) {
					if (rs.code == '00000') {
						vmMenus.haveList = rs.data;
						for (var i = 0; i < rs.data.length; i++) {
							var menu = rs.data[i];
							$("#m" + menu.menuId).prop({ checked: true });
						}
						initUI();
					} else {
						AlertMsg(rs.msg);
						console.error(rs);
					}
				},
				error: function (xhr, status, ex) {
					AlertMsg("请求失败：" + xhr.statusText);
					console.error(ex);
				}
			});
		}
		function initUI() {
			layui.use(['layer', 'form', 'element'], function () {
				var uiform = layui.form();
				uiform.on('checkbox(menu)', function (data) {
					selectHandler(data.elem, data.elem.checked);
					uiform.render();
				});
			});
		}
		function selectHandler(elem, isChecked) {
			//选中时，需要选中上级节点
			if (isChecked) {
				var pid = $(elem).attr("pid");
				if (pid != '#') {
					$("#m" + pid).prop({ checked: true });
					var ppid = $('#m' + pid).attr("pid");
					if (ppid != '#') {
						$("#m" + ppid).prop({ checked: true });
					}
				}
			}
			//取消时，需要取消下级节点
			else {
				var id = $(elem).attr("id");
				id = id.substring(1);
				var sons = $("input[pid='" + id + "']");
				if (sons) {
					for (var i = 0; i < sons.length; i++) {
						//$('m'+sons[j].attr("id")).removeAttr("checked");
						$(sons[i]).prop({ checked: false });
						var sonid = $(sons[i]).attr("id");
						sonid = sonid.substring(1);
						var suns = $("input[pid='" + sonid + "']");
						if (suns) {
							for (var j = 0; j < suns.length; j++) {
								//$('m'+suns[j].attr("id")).removeAttr("checked");
								$(suns[j]).prop({ checked: false });
							}
						}
					}
				}
			}
		}
	</script>
</body>

</html>